# Data Model: RAG Content Ingestion Pipeline

## Overview
This document defines the data structures and entities used in the RAG content ingestion pipeline, based on the feature specification requirements.

## Core Entities

### TextChunk
Represents a segment of book content with associated metadata.

**Fields**:
- `id` (str): Unique identifier generated from URL and content hash for idempotency
- `content` (str): The actual text content of the chunk
- `source_url` (str): The original URL from which the content was extracted
- `page_number` (int): Page number from the original document (if available)
- `section_title` (str): Title of the section/chapter (if available)
- `created_at` (datetime): Timestamp when the chunk was created
- `word_count` (int): Number of words in the content

**Validation Rules**:
- Content must not be empty
- Source URL must be a valid URL
- Word count must be positive

### Embedding
Vector representation of a text chunk generated by the Cohere model.

**Fields**:
- `chunk_id` (str): Reference to the associated TextChunk
- `vector` (List[float]): The embedding vector (expected to be 1024-dimensional for Cohere)
- `model_version` (str): Version of the embedding model used
- `generated_at` (datetime): Timestamp when the embedding was generated

**Validation Rules**:
- Vector must have consistent dimensions (1024 for Cohere)
- Chunk reference must exist
- Vector values must be finite numbers

### ProcessingResult
Captures the status and metrics of a pipeline execution.

**Fields**:
- `execution_id` (str): Unique identifier for this pipeline run
- `start_time` (datetime): When the pipeline started
- `end_time` (datetime): When the pipeline completed
- `total_urls_processed` (int): Number of URLs successfully processed
- `total_chunks_created` (int): Number of text chunks created
- `total_embeddings_generated` (int): Number of embeddings generated
- `errors` (List[str]): List of any errors encountered during processing
- `status` (str): Final status (e.g., "success", "partial", "failed")

**Validation Rules**:
- Execution ID must be unique
- End time must be after start time
- Counts must be non-negative

## Relationships

```
TextChunk (1) <-- (1) Embedding
```
Each TextChunk has exactly one corresponding Embedding.

## State Transitions

### TextChunk States
- `created`: Chunk has been extracted from URL but not yet embedded
- `embedded`: Embedding has been generated for the chunk
- `stored`: Chunk and embedding have been saved to Qdrant

### ProcessingResult States
- `running`: Pipeline is currently executing
- `completed`: Pipeline finished successfully
- `failed`: Pipeline encountered errors
- `partial`: Pipeline completed with some errors

## Qdrant Collection Schema

### Collection: rag_embedding
**Vector Configuration**:
- Vector size: 1024 (for Cohere embeddings)
- Distance function: Cosine

**Payload Schema**:
- `source_url` (keyword): Original URL of the content
- `page_number` (integer): Page number from the book
- `section_title` (keyword): Title of the section
- `content` (text): The actual text content
- `chunk_id` (keyword): Unique identifier for the chunk
- `created_at` (datetime): When the chunk was created

## Metadata Preservation

The system will preserve the following metadata from the source:
- Source URL for attribution and reference
- Page numbers for location context
- Section titles for semantic context
- Creation timestamp for tracking
- Word count for content analysis